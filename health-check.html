<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Growth Manager Pro - Enhanced System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* System Status Panel */
        .system-status {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .status-title {
            font-size: 1.8rem;
            color: #2c3e50;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-light {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-light.active {
            background: #27ae60;
        }

        .status-light.warning {
            background: #f39c12;
        }

        .status-light.error {
            background: #e74c3c;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Contact Deduplication Module */
        .dedup-module {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .dedup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .dedup-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
        }

        .dedup-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .dedup-stat {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .dedup-stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #3498db;
        }

        .dedup-stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        /* Meeting Type Manager */
        .meeting-manager {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .meeting-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .meeting-card {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .meeting-card.active {
            border-color: #27ae60;
            background: #e8f5e8;
        }

        .meeting-card.blocked {
            opacity: 0.5;
            border-color: #e74c3c;
        }

        .meeting-type-label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }

        .meeting-details {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-bottom: 1rem;
        }

        .meeting-status {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Live Data Monitor */
        .live-data-monitor {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .data-stream {
            background: #1e1e1e;
            color: #00ff00;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .data-entry {
            margin-bottom: 0.5rem;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        /* Invite Language Checker */
        .invite-checker {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .invite-template {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #3498db;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .template-title {
            font-weight: 600;
            color: #2c3e50;
        }

        .template-status {
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            background: #d5f4e6;
            color: #27ae60;
        }

        .template-content {
            font-size: 0.9rem;
            color: #5a6c7d;
            line-height: 1.6;
        }

        .template-warnings {
            margin-top: 1rem;
            padding: 0.8rem;
            background: #fff3cd;
            border-radius: 6px;
            font-size: 0.85rem;
            color: #856404;
        }

        /* Buttons */
        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #27ae60;
            color: white;
        }

        .btn-primary:hover {
            background: #2ecc71;
        }

        .btn-secondary {
            background: #ecf0f1;
            color: #2c3e50;
            border: 1px solid #bdc3c7;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        /* Alerts */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d5f4e6;
            color: #155724;
            border: 1px solid #27ae60;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #f39c12;
        }

        .alert-danger {
            background: #fef2f2;
            color: #721c24;
            border: 1px solid #e74c3c;
        }

        /* Contact History Table */
        .contact-history {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .history-table th {
            background: #f8f9fa;
            padding: 0.8rem;
            text-align: left;
            font-weight: 600;
            color: #2c3e50;
            border-bottom: 2px solid #dee2e6;
        }

        .history-table td {
            padding: 0.8rem;
            border-bottom: 1px solid #dee2e6;
        }

        .history-table tr:hover {
            background: #f8f9fa;
        }

        /* Toggle Switch */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .switch {
            position: relative;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #27ae60;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- System Status Panel -->
        <div class="system-status">
            <div class="status-header">
                <h1 class="status-title">System Health Check</h1>
                <div class="status-indicator">
                    <span class="status-light active"></span>
                    <span>All Systems Operational</span>
                </div>
            </div>
            
            <div class="alert alert-success">
                ‚úÖ Contact Deduplication Module: Active<br>
                ‚úÖ Meeting Type Lock: Enabled<br>
                ‚úÖ Invite History Tracking: Running<br>
                ‚úÖ Live Data Connection: Established
            </div>
        </div>

        <!-- Contact Deduplication Module -->
        <div class="dedup-module">
            <div class="dedup-header">
                <h2 class="dedup-title">Contact Deduplication & History Check</h2>
                <div class="toggle-switch">
                    <label>Auto-Prevent Duplicates</label>
                    <label class="switch">
                        <input type="checkbox" checked onchange="toggleDedup(this)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="dedup-stats">
                <div class="dedup-stat">
                    <div class="dedup-stat-number" id="totalContacts">0</div>
                    <div class="dedup-stat-label">Total Contacts</div>
                </div>
                <div class="dedup-stat">
                    <div class="dedup-stat-number" id="duplicatesFound">0</div>
                    <div class="dedup-stat-label">Duplicates Prevented</div>
                </div>
                <div class="dedup-stat">
                    <div class="dedup-stat-number" id="invitesSent">0</div>
                    <div class="dedup-stat-label">Invites Sent Today</div>
                </div>
                <div class="dedup-stat">
                    <div class="dedup-stat-number" id="invitesBlocked">0</div>
                    <div class="dedup-stat-label">Invites Blocked</div>
                </div>
            </div>

            <div class="contact-history">
                <h3 style="margin-bottom: 1rem;">Recent Contact History</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Contact</th>
                            <th>Email</th>
                            <th>Last Invite</th>
                            <th>Meeting Type</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contactHistoryTable">
                        <!-- Dynamic content -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Meeting Type Manager -->
        <div class="meeting-manager">
            <h2 style="margin-bottom: 1rem;">Current Meeting Type Lock System</h2>
            
            <div class="alert alert-warning">
                ‚ö†Ô∏è Once a contact receives one type of invite, they are locked from receiving other types for 7 days
            </div>

            <div class="meeting-grid">
                <div class="meeting-card" id="podcastCard">
                    <div class="meeting-type-label">üìû Podcast Interview</div>
                    <div class="meeting-details">
                        Duration: 60 minutes<br>
                        Auto-trigger: New qualified prospects (35+)<br>
                        Currently scheduled: <span id="podcastCount">0</span>
                    </div>
                    <div class="meeting-status">
                        <span>Status: Active</span>
                        <button class="btn btn-secondary" onclick="reviewMeetingType('podcast')">Review</button>
                    </div>
                </div>

                <div class="meeting-card" id="discoveryCard">
                    <div class="meeting-type-label">üéØ Discovery Call</div>
                    <div class="meeting-details">
                        Duration: 60 minutes<br>
                        Auto-trigger: After podcast completion<br>
                        Currently scheduled: <span id="discoveryCount">2</span>
                    </div>
                    <div class="meeting-status">
                        <span>Status: Active</span>
                        <button class="btn btn-secondary" onclick="reviewMeetingType('discovery')">Review</button>
                    </div>
                </div>

                <div class="meeting-card" id="salesCard">
                    <div class="meeting-type-label">üìà Sales Call</div>
                    <div class="meeting-details">
                        Duration: 45 minutes<br>
                        Auto-trigger: After positive growth plan response<br>
                        Currently scheduled: <span id="salesCount">0</span>
                    </div>
                    <div class="meeting-status">
                        <span>Status: Active</span>
                        <button class="btn btn-secondary" onclick="reviewMeetingType('sales')">Review</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Invite Language Checker -->
        <div class="invite-checker">
            <h2 style="margin-bottom: 1rem;">Invite Language Templates</h2>
            
            <div class="invite-template">
                <div class="template-header">
                    <div class="template-title">Podcast Interview Invite</div>
                    <div class="template-status">Approved</div>
                </div>
                <div class="template-content">
                    <strong>Subject:</strong> Podcast Interview Invitation - [NAME]<br><br>
                    <strong>Body:</strong><br>
                    Hi [NAME],<br><br>
                    Following our recent conversation, I'd love to invite you to be featured on our podcast where we discuss growth strategies for [INDUSTRY] businesses.<br><br>
                    This is a relaxed, 60-minute conversation about your business journey and current challenges - not a sales call. Many of our guests find it valuable just to talk through their business with someone who understands the space.<br><br>
                    [CALENDLY_LINK]<br><br>
                    Looking forward to our conversation!<br>
                    Maggie
                </div>
                <div class="template-warnings">
                    ‚ö†Ô∏è Check: Ensure this is only sent to NEW prospects who haven't had any prior meetings
                </div>
                <button class="btn btn-secondary" onclick="editTemplate('podcast')">Edit Template</button>
            </div>

            <div class="invite-template">
                <div class="template-header">
                    <div class="template-title">Discovery Call Invite</div>
                    <div class="template-status">Needs Review</div>
                </div>
                <div class="template-content">
                    <strong>Subject:</strong> Discovery Call - Next Steps from Our Podcast<br><br>
                    <strong>Body:</strong><br>
                    Hi [NAME],<br><br>
                    Thank you for the great podcast conversation! Based on what we discussed about [PAIN_POINTS], I'd love to schedule a discovery call to dive deeper into how we might help you achieve [GOALS].<br><br>
                    This is a structured 60-minute call where we'll:<br>
                    - Review your current challenges in detail<br>
                    - Discuss your growth goals for the next 12 months<br>
                    - Explore potential solutions specific to your situation<br><br>
                    [CALENDLY_LINK]<br><br>
                    Best,<br>
                    Maggie
                </div>
                <div class="template-warnings">
                    ‚ö†Ô∏è Check: Only send AFTER podcast is completed and qualified (35+)
                </div>
                <button class="btn btn-secondary" onclick="editTemplate('discovery')">Edit Template</button>
            </div>
        </div>

        <!-- Live Data Monitor -->
        <div class="live-data-monitor">
            <h2>Live Data Stream</h2>
            <div class="data-stream" id="dataStream">
                <div class="data-entry">[09:23:45] System initialized...</div>
                <div class="data-entry">[09:23:46] Connecting to API endpoints...</div>
                <div class="data-entry">[09:23:47] Loading prospects from /api/prospects...</div>
            </div>
            <div style="margin-top: 1rem; display: flex; gap: 1rem;">
                <button class="btn btn-primary" onclick="testLiveData()">Test Live Connection</button>
                <button class="btn btn-secondary" onclick="clearDataStream()">Clear Log</button>
                <button class="btn btn-warning" onclick="forceSync()">Force Sync</button>
            </div>
        </div>
    </div>

    <script>
        // Global state management
        let contactDatabase = [];
        let inviteHistory = [];
        let blockedContacts = new Set();
        
        // Initialize the system
        async function initializeSystem() {
            logToStream('Initializing enhanced Growth Manager Pro system...');
            
            // Load existing contacts
            await loadContacts();
            
            // Start monitoring
            startRealtimeMonitoring();
            
            // Check for duplicates
            checkForDuplicates();
            
            logToStream('System ready. All safety checks active.');
        }

        // Load contacts with deduplication
        async function loadContacts() {
            logToStream('Fetching contact data from API...');
            
            try {
                const response = await fetch('/api/prospects');
                const data = await response.json();
                
                if (data.prospects) {
                    contactDatabase = data.prospects;
                    
                    // Process for duplicates
                    const emailMap = new Map();
                    let duplicateCount = 0;
                    
                    data.prospects.forEach(prospect => {
                        const email = prospect.email?.toLowerCase();
                        if (email) {
                            if (emailMap.has(email)) {
                                duplicateCount++;
                                logToStream(`‚ö†Ô∏è Duplicate found: ${prospect.name} (${email})`);
                            } else {
                                emailMap.set(email, prospect);
                            }
                        }
                    });
                    
                    // Update stats
                    document.getElementById('totalContacts').textContent = data.prospects.length;
                    document.getElementById('duplicatesFound').textContent = duplicateCount;
                    
                    // Update contact history table
                    updateContactHistoryTable(data.prospects);
                    
                    logToStream(`‚úÖ Loaded ${data.prospects.length} contacts (${duplicateCount} duplicates detected)`);
                }
            } catch (error) {
                logToStream(`‚ùå Error loading contacts: ${error.message}`);
            }
        }

        // Update contact history table
        function updateContactHistoryTable(prospects) {
            const tbody = document.getElementById('contactHistoryTable');
            
            // Get recent prospects with any meeting activity
            const recentProspects = prospects
                .filter(p => p.pipeline_stage !== 'new')
                .slice(0, 10);
            
            tbody.innerHTML = recentProspects.map(prospect => {
                const lastInvite = getLastInviteDate(prospect);
                const meetingType = getCurrentMeetingType(prospect);
                const isBlocked = shouldBlockInvite(prospect);
                
                return `
                    <tr>
                        <td>${prospect.name}</td>
                        <td>${prospect.email || 'No email'}</td>
                        <td>${lastInvite}</td>
                        <td>
                            <span style="background: #e3f2fd; color: #1976d2; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem;">
                                ${meetingType}
                            </span>
                        </td>
                        <td>
                            ${isBlocked ? 
                                '<span style="color: #e74c3c;">üîí Locked</span>' : 
                                '<span style="color: #27ae60;">‚úÖ Available</span>'
                            }
                        </td>
                        <td>
                            <button class="btn btn-secondary" onclick="overrideContact('${prospect.id}')" ${!isBlocked ? 'disabled' : ''}>
                                Override
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Get last invite date for a prospect
        function getLastInviteDate(prospect) {
            // Check various date fields
            if (prospect.last_invite_sent) {
                return new Date(prospect.last_invite_sent).toLocaleDateString();
            }
            if (prospect.last_activity_date) {
                return new Date(prospect.last_activity_date).toLocaleDateString();
            }
            return 'Never';
        }

        // Get current meeting type for prospect
        function getCurrentMeetingType(prospect) {
            const stageMap = {
                'qualified_for_discovery': 'Discovery Call',
                'discovery_link_sent': 'Discovery Call',
                'discovery_completed': 'Growth Plan',
                'proposal_sent': 'Sales Call',
                'closed_won': 'Complete'
            };
            
            // Check if they're in podcast stage
            if (prospect.qualification_score >= 35 && prospect.pipeline_stage === 'new') {
                return 'Podcast Interview';
            }
            
            return stageMap[prospect.pipeline_stage] || 'None';
        }

        // Check if invite should be blocked
        function shouldBlockInvite(prospect) {
            if (!prospect.last_invite_sent) return false;
            
            const lastInvite = new Date(prospect.last_invite_sent);
            const now = new Date();
            const daysSince = (now - lastInvite) / (1000 * 60 * 60 * 24);
            
            // Block if invite was sent within 7 days
            return daysSince < 7;
        }

        // Real-time monitoring
        function startRealtimeMonitoring() {
            logToStream('Starting real-time monitoring...');
            
            // Check for changes every 30 seconds
            setInterval(() => {
                checkForNewInvites();
                checkForDuplicates();
            }, 30000);
        }

        // Check for new invites being sent
        function checkForNewInvites() {
            // This would connect to your Calendly/Instantly webhooks
            const mockNewInvite = {
                contact: 'Test User',
                type: 'podcast',
                timestamp: new Date().toISOString()
            };
            
            // Validate before allowing
            if (validateInvite(mockNewInvite)) {
                logToStream(`‚úÖ Invite validated: ${mockNewInvite.contact}`);
            } else {
                logToStream(`üö´ Invite blocked: ${mockNewInvite.contact} (duplicate prevention)`);
                document.getElementById('invitesBlocked').textContent = 
                    parseInt(document.getElementById('invitesBlocked').textContent) + 1;
            }
        }

        // Validate invite before sending
        function validateInvite(invite) {
            // Check if contact already has a recent invite
            const existingInvite = inviteHistory.find(h => 
                h.contact === invite.contact && 
                new Date() - new Date(h.timestamp) < 7 * 24 * 60 * 60 * 1000
            );
            
            if (existingInvite) {
                return false; // Block the invite
            }
            
            // Add to history
            inviteHistory.push(invite);
            return true;
        }

        // Check for duplicate contacts
        function checkForDuplicates() {
            const emailMap = new Map();
            const phoneMap = new Map();
            const duplicates = [];
            
            contactDatabase.forEach(contact => {
                // Check email duplicates
                if (contact.email) {
                    const email = contact.email.toLowerCase();
                    if (emailMap.has(email)) {
                        duplicates.push({
                            original: emailMap.get(email),
                            duplicate: contact,
                            type: 'email'
                        });
                    } else {
                        emailMap.set(email, contact);
                    }
                }
                
                // Check phone duplicates
                if (contact.phone) {
                    const phone = contact.phone.replace(/\D/g, '');
                    if (phoneMap.has(phone)) {
                        duplicates.push({
                            original: phoneMap.get(phone),
                            duplicate: contact,
                            type: 'phone'
                        });
                    } else {
                        phoneMap.set(phone, contact);
                    }
                }
            });
            
            if (duplicates.length > 0) {
                logToStream(`‚ö†Ô∏è Found ${duplicates.length} duplicate contacts`);
            }
            
            return duplicates;
        }

        // Log to data stream
        function logToStream(message) {
            const stream = document.getElementById('dataStream');
            const timestamp = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'data-entry';
            entry.textContent = `[${timestamp}] ${message}`;
            stream.appendChild(entry);
            stream.scrollTop = stream.scrollHeight;
        }

        // Test live data connection
        async function testLiveData() {
            logToStream('Testing live data connection...');
            
            try {
                // Test Calendly
                logToStream('Checking Calendly integration...');
                const calendlyTest = await fetch('/api/calendly-integration');
                if (calendlyTest.ok) {
                    logToStream('‚úÖ Calendly connected');
                } else {
                    logToStream('‚ùå Calendly connection failed');
                }
                
                // Test Instantly
                logToStream('Checking Instantly integration...');
                const instantlyTest = await fetch('/api/instantly-integration');
                if (instantlyTest.ok) {
                    logToStream('‚úÖ Instantly connected');
                } else {
                    logToStream('‚ùå Instantly connection failed');
                }
                
                // Test prospects API
                logToStream('Checking prospects API...');
                const prospectsTest = await fetch('/api/prospects');
                if (prospectsTest.ok) {
                    const data = await prospectsTest.json();
                    logToStream(`‚úÖ Prospects API: ${data.prospects?.length || 0} contacts`);
                } else {
                    logToStream('‚ùå Prospects API failed');
                }
                
            } catch (error) {
                logToStream(`‚ùå Connection test failed: ${error.message}`);
            }
        }

        // Force sync all data
        async function forceSync() {
            logToStream('Forcing full system sync...');
            await loadContacts();
            checkForDuplicates();
            logToStream('‚úÖ Sync complete');
        }

        // Clear data stream
        function clearDataStream() {
            document.getElementById('dataStream').innerHTML = 
                '<div class="data-entry">[' + new Date().toLocaleTimeString() + '] Log cleared</div>';
        }

        // Toggle deduplication
        function toggleDedup(checkbox) {
            if (checkbox.checked) {
                logToStream('‚úÖ Deduplication enabled');
            } else {
                logToStream('‚ö†Ô∏è Deduplication disabled - manual review required');
            }
        }

        // Review meeting type
        function reviewMeetingType(type) {
            const contacts = contactDatabase.filter(c => getCurrentMeetingType(c).toLowerCase().includes(type));
            alert(`${type.charAt(0).toUpperCase() + type.slice(1)} meetings:\n\nTotal: ${contacts.length}\n\nContacts:\n${contacts.slice(0, 5).map(c => `- ${c.name}`).join('\n')}`);
        }

        // Override contact lock
        function overrideContact(contactId) {
            if (confirm('Are you sure you want to override the meeting lock for this contact? This may result in duplicate invites.')) {
                blockedContacts.delete(contactId);
                logToStream(`‚ö†Ô∏è Manual override: Contact ${contactId} unlocked`);
                updateContactHistoryTable(contactDatabase);
            }
        }

        // Edit template
        function editTemplate(type) {
            alert(`Template editor for ${type} invites would open here. This would allow you to modify the language while maintaining merge tags.`);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initializeSystem();
        });

        // Auto-refresh every 2 minutes
        setInterval(() => {
            loadContacts();
        }, 120000);
    </script>
</body>
</html>
